## chapter 21 类元编程

**主要内容**

- [x] 创建类
- [x] 导入时和运行时的区别

> (元类)时深奥的知识，99%的用户都无需关注。

#### 1、什么是类元编程？

* 类元编程时指在运行时创建或定制类的技艺。

类元编程的特性：

* 在Python中，类是一等对象，因此任何时候都可以使用函数新建类，而无需使用class关键字；
* 元类是类元编程最高级的工具，使用元类可以创建具有某种特质的全新类种，例如我们见过的抽象基类；
* 元类功能强大，但是难以掌握。由于类装饰器能使用更简单的方式解决很多问题，所以在Python2.6引入类装饰器之后，元类很难使用真是的代码说明。

**【注意】：除非开发框架，否则不要编写元类。然而，为了寻找乐趣或者练习相关的概念，可以这么做。**

#### 2、类工厂函数

本书中经常提到的`collections.nametuple`，把一个类名和几个属性传给这个函数，它会创建一个`tuple`的子类，其中的元素通过名称获取，还为调试提供了友好的字符串表示形式(`__repr__`)。

可以使用`type`创建类工厂函数，`type`的三个参数分别为`name`(类名)、`bases`(基类的名称，类型为元组)、`dict`（映射，类型为字典，指定新的属性名和值）。

通过类工厂函数`record_factory`函数创建的类，不能序列化（不能使用pickle模块的load/dump函数处理）。【可以参考`nametuple`的源代码，在其源代码搜索`pickling`即可，待看】

#### 3、导入时和运行时的区别

[参考代码](https://github.com/feng-hui/fluent_python_examples/blob/master/chapter_21/ch21_evaltime.py),可以在命令行导入该模块查看运行的结果或者直接运行该文件，可以比较直观地看到导入时和运行时地区别。

* 导入时:
    * 01、在导入时，解释器会从上到下一次性解析完.py模块的源码，然后生成用于执行的字节码。
    * 02、如果句法有错误，就在此时报告。如果本地的`__pycache__`文件夹中有最新的.pyc文件，解释器会跳过上述步骤。
    * 03、在使用`import`语句的时候，它不只是声明，在进程首次导入模块时，还会执行所导入模块的全部顶层代码——以后导入相同的模块则使用缓存，只做名称绑定。那些顶层代码可以做任何“运行时”做的事，例如连接数据库。
    * 04、导入模块时，解释器会执行顶层的`def`语句，解释器会编译函数的定义体(首次导入时)，把函数对象绑定对应的全局名称上，但不会执行函数的定义体（函数的定义体会在调用的时候执行）；但在导入类的时候，解释器会执行每个类的定义体甚至会执行嵌套的定义体，执行主要是定义类的属性和方法并构建了类对象。

* 运行时:
    * 直接运行文件

* 总结：
    * 导入时，解释器会从上到下依此执行导入模块及其依赖中的每个类定义体（函数不会执行、类中的定义体会执行但不包括类方法）；在遇到装饰器的时候，会先计算类的定义体然后调用依附在类上的装饰器，因为必须先构建类对象，装饰器才有类对象可处理。
    * 运行时，类装饰器不会影响子类，只有子类在调用超类的方法会触发装饰器；装饰器会改变实例调用的方法；在程序运行结束时，实例会垃圾回收程序回收。

#### 4、元类基础知识

* 01、元类（[record_factory](https://github.com/feng-hui/fluent_python_examples/blob/master/chapter_21/ch21_record_factory.py)是制造类地工厂，不过不是函数），而是类。
* 02、默认情况下，Python中的类是type类的实例，type是大多数内置的类和用户定义的类的元类，同时为了避免回溯，type是其自身的实例。
* 03、object和type类之间的关系很独特：object是type的实例，而type是object的子类。

#### 5、元类的特殊方法`__prepare__`

* `__prepare__`是Python3引入的特殊方法，这个特殊方法只在元类中有用，而且必须声明为类方法（需要声明为@classmethod）
* 解释器调用元类的`__new__`方法之前会先调用`__prepare__`方法，使用类中的定义体中的属性创建映射。
* 元类构建新类时，`__prepare__`方法返回的映射会给`__new__`方法的最后一个参数，然后再传给`__init__`方法。
* `__prepare__`方法的第一个参数时元类(cls)，随后两个参数分别是构建的类的名称和基类组成的元组。

#### 6、元类的用途

* 验证属性
* 一次把装饰器依附到多个方法上
* 序列化对象或转换数据
* 对象关系映射
* 基于对象的永久存储
* 动态转换使用其他语言编写的类结构

```
—— 整理人Fenghui
—— 整理时间：2019-03-24 08:54:10.991185
```